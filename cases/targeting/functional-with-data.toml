# Test Case: Targeting Functional (with CSV data)

name = "functional-with-data"
description = "Verify targeting process with pre-downloaded CSV data"
timeout = 300 # seconds

# Test prompt sent to Claude
test_prompt = """
You are a Patent Engineer who has just received a draft invention specification.

I have placed an invention specification in `0-specifications/specification.md` and downloaded CSV files in `1-targeting/csv/`.

Please perform the Phase 1 targeting step and then merge the CSV data to create `1-targeting/target.jsonl`.

If asked about modifying keywords or synonyms: "Looks good, proceed to merge."
"""

# Setup files to be copied to workspace
[[setup]]
path = "0-specifications/specification.md"
content = """
# Product Specification

**Product/Technology**:
Solar-powered auto-cleaning cat litter box with IoT notifications.

**Background**:
Current cat litter boxes require manual scooping and frequent bag changes, which leads to odor and hygiene issues.

**Key Technical Features**:

1. A solar panel integrated into the top hood that charges an internal battery.
2. A rotating internal drum that separates solid waste into a sealed compartment.
3. An IoT module (Wi-Fi) that sends push notifications to a smartphone when the waste compartment is full.

**Competitors**:

- Litter-Robot
- CatGenie
"""

[[setup]]
path = "1-targeting/csv/sample1.csv"
content = """
publication_number,title,assignee
US9433185B2,Automated pet care assembly with sensor,"Automated Pet Care Products, Llc"
US11399502B2,Waste compartment monitoring,Automated Pet Care Products, Llc
US11963512B1,Pet toilet with rotating drum,PetPivot INC
"""

[[setup]]
path = "1-targeting/csv/sample2.csv"
content = """
publication_number,title,assignee
US20200178505A1,Solar-powered pet monitoring,Botsitter, Llc
US10582621B2,Cat litter box,CatGenie
US10856789B2,Automatic litter device,Litter-Robot
"""

# Evaluation checks
[[checks]]
name = "init_validation"
type = "log"
jq = "[.[] | select(.type == \"system\" and .subtype == \"init\")] | length > 0 and (.[0] | .plugins[]?.name == \"patent-kit\" and (.skills? | any(. == \"patent-kit:targeting\")) and any(.mcp_servers[]?; (.name | test(\"google-patent-cli\")) and .status == \"connected\") and any(.mcp_servers[]?; (.name | test(\"arxiv-cli\")) and .status == \"connected\"))"

[[checks]]
name = "constitution_loaded"
type = "script"
command = "check-skill-invoked.sh constitution-reminding"

[[checks]]
name = "targeting_template_read"
type = "log"
jq = "[.[] | .message.content[]? | select(type == \"object\" and .type == \"tool_use\" and .name == \"Read\" and (.input.file_path | test(\"targeting-template.md\")))] | length > 0"

[[checks]]
name = "keywords_template_read"
type = "log"
jq = "[.[] | .message.content[]? | select(type == \"object\" and .type == \"tool_use\" and .name == \"Read\" and (.input.file_path | test(\"keywords-template.md\")))] | length > 0"

[[checks]]
name = "keywords_md_created"
type = "workspace"
command = "[ -f 1-targeting/keywords.md ]"

[[checks]]
name = "search_patents_called"
type = "log"
jq = "[.[] | (.message.content[]?.name? // \"\") | test(\"google-patent-cli__search_patents\")] | any"

[[checks]]
name = "google_patent_mcp_succeeded"
type = "script"
command = "./check-mcp-success.sh"
mcp_tool = "google-patent-cli__search_patents"

[[checks]]
name = "noise_analysis_performed"
type = "log"
jq = "[.[] | .message.content[]? | select(type == \"object\" and .type == \"text\" and (.text | test(\"noise|Noise|irrelevant|Irrelevant|snippets|Snippets\")))] | length > 0"

[[checks]]
name = "targeting_md_created"
type = "workspace"
command = "[ -f 1-targeting/targeting.md ]"

[[checks]]
name = "merge_executed"
type = "log"
jq = "[.[] | .message.content[]? | select(type == \"tool_use\" and .name == \"Bash\" and (.input.command | test(\"merge\")))] | length > 0"

[[checks]]
name = "target_jsonl_exists"
type = "workspace"
command = "[ -f 1-targeting/target.jsonl ] && [ $(wc -l < 1-targeting/target.jsonl) -gt 0 ]"
