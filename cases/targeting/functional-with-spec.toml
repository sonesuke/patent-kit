# Test Case: Targeting Functional (with existing specification)

name = "functional-with-spec"
description = "Verify targeting process with existing specification"
timeout = 300 # seconds

# Test prompt sent to Claude
test_prompt = """
You are a Patent Engineer who has just received a draft invention specification.

I have placed an invention specification in `0-specifications/specification.md`. Please read it and perform the Phase 1 targeting step (search query generation) for a 2025 product release.

If asked about modifying keywords or synonyms: "Looks good, proceed to search."
If asked whether the query hit counts are acceptable (~1000 hits): "The count is acceptable, proceed to merge."
"""

# Setup files to be copied to workspace
[[setup]]
path = "0-specifications/specification.md"
content = """
# Specification Dummy

**Product/Technology**:
Solar-powered auto-cleaning cat litter box with IoT notifications.

**Background**:
Current cat litter boxes require manual scooping and frequent bag changes, which leads to odor and hygiene issues.

**Key Technical Features**:

1. A solar panel integrated into the top hood that charges an internal battery.
2. A rotating internal drum that separates solid waste into a sealed compartment.
3. An IoT module (Wi-Fi) that sends push notifications to a smartphone when the waste compartment is full.

**Competitors**:

- Litter-Robot
- CatGenie
"""

# Evaluation checks
[[checks]]
name = "init_validation"
type = "log"
jq = "select(.type == \"system\" and .subtype == \"init\") | .plugins[]?.name == \"patent-kit\" and (.skills? | any(. == \"patent-kit:targeting\")) and any(.mcp_servers[]?; (.name | test(\"google-patent-cli\")) and .status == \"connected\") and any(.mcp_servers[]?; (.name | test(\"arxiv-cli\")) and .status == \"connected\")"

[[checks]]
name = "constitution_loaded"
type = "log"
jq = ".message.content[]? | select(.type == \"tool_use\" and .name == \"Skill\" and (.input.skill | test(\"constitution\")))"

[[checks]]
name = "targeting_template_read"
type = "log"
jq = ".message.content[]? | select(.type == \"tool_use\" and .name == \"Read\" and (.input.file_path | test(\"targeting-template.md\")))"

[[checks]]
name = "keywords_template_read"
type = "log"
jq = ".message.content[]? | select(.type == \"tool_use\" and .name == \"Read\" and (.input.file_path | test(\"keywords-template.md\")))"

[[checks]]
name = "keywords_md_created"
type = "workspace"
command = "[ -f 1-targeting/keywords.md ]"

[[checks]]
name = "search_patents_called"
type = "log"
jq = "(.message.content[]?.name? // \"\") | test(\"google-patent-cli__search_patents\")"

# TODO: Replace string matching with isError field check once google-patent-cli MCP server returns isError: true on errors
[[checks]]
name = "google_patent_mcp_succeeded"
type = "log"
jq = "map(select(.type == \"assistant\" and (.message.content[]?.name // \"\" | test(\"google-patent-cli__search_patents\"))) | .message.content[]?.id) as $tool_ids | map(select(.type == \"user\" and (.message.content[]?.tool_use_id // \"\" | IN($tool_ids[])))) | all(.message.content[]?.content[]?.text // \"\" | test(\"Search failed|Browser error|Chrome|SIGABRT\") | not)"

[[checks]]
name = "noise_analysis_performed"
type = "log"
jq = ".message.content[]? | select(.type == \"text\" and (.text | test(\"noise|Noise|irrelevant|Irrelevant|snippets|Snippets\")))"

[[checks]]
name = "targeting_md_created"
type = "workspace"
command = "[ -f 1-targeting/targeting.md ]"

[[checks]]
name = "target_jsonl_exists"
type = "workspace"
command = "[ -f 1-targeting/target.jsonl ] && [ $(wc -l < 1-targeting/target.jsonl) -gt 0 ]"
